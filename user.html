<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BiteHub User Portal</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="user.css">
</head>

<body>

<!-- NAVBAR -->
<div class="navbar">
  <div><b>Welcome ğŸ‘‹</b></div>

  <div class="nav-right">
    <a href="cart.html">ğŸ›’ Cart <span class="cart-badge">0</span></a>
    <a href="notifications.html" class="notif-link">ğŸ”” <span class="notif-badge">0</span></a>
    <a href="recent_orders.html">ğŸ“„ Recent Orders</a>
    <a href="logout.html">Logout</a>
  </div>
</div>

<h2 class="page-title">ğŸ½ï¸ Todayâ€™s Menu</h2>

<!-- MENU -->
<div class="menu-container" id="menu"></div>

<!-- TOAST -->
<div id="toast"></div>

<!-- AI -->
<div id="ai-btn">ğŸ¤–</div>
<div id="ai-chatbox">
  <div id="ai-header">BiteHub AI Assistant</div>
  <div id="ai-messages"></div>
  <div id="ai-input-area">
    <input id="ai-input" placeholder="Ask somethingâ€¦">
    <button id="ai-send">Send</button>
  </div>
</div>

<script>
/* =====================
   LOAD MENU
===================== */
fetch('/api/get_menu')
  .then(r => r.json())
  .then(data => {
    const menu = document.getElementById('menu');
    menu.innerHTML = '';

    data.menu.forEach(item => {
      menu.innerHTML += `
        <div class="card">
          <img src="${item.image || ''}">
          <h3>${item.name}</h3>
          <p><b>â‚±${item.price}</b></p>
          <button class="order-btn" onclick="addToCart(${item.id}, this)">
            Add to Cart
          </button>
        </div>
      `;
    });
  });

/* =====================
   ADD TO CART
===================== */
function addToCart(menu_id, btn) {
  btn.disabled = true;
  btn.innerText = 'Adding...';

  fetch('/api/add_to_cart', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ menu_id, quantity: 1 })
  })
  .then(r => r.json())
  .then(() => {
    showToast('Added to cart');
    loadCart();
  })
  .catch(() => alert('Error'))
  .finally(() => {
    btn.disabled = false;
    btn.innerText = 'Add to Cart';
  });
}

/* =====================
   COUNTERS
===================== */
function loadCart() {
  fetch('/api/fetch_cart_count')
    .then(r => r.json())
    .then(d => document.querySelector('.cart-badge').innerText = d.count || 0);
}

function loadNotif() {
  fetch('/api/fetch_notifications')
    .then(r => r.json())
    .then(d => document.querySelector('.notif-badge').innerText = d.notifications.length);
}

/* =====================
   TOAST
===================== */
function showToast(msg) {
  const t = document.getElementById('toast');
  t.innerText = msg;
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 2000);
}

/* =====================
   AI CHAT
===================== */
document.getElementById('ai-btn').onclick = () =>
  document.getElementById('ai-chatbox').classList.toggle('open');

document.getElementById('ai-send').onclick = sendAI;

function sendAI() {
  const input = document.getElementById('ai-input');
  const msg = input.value.trim();
  if (!msg) return;

  append('You', msg);
  input.value = '';

  fetch('/api/test_curl', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ message: msg })
  })
  .then(r => r.json())
  .then(d => append('AI', d.reply || 'No reply'));
}

function append(who, text) {
  const p = document.createElement('p');
  p.innerHTML = `<b>${who}:</b> ${text}`;
  document.getElementById('ai-messages').appendChild(p);
}

/* INIT */
loadCart();
loadNotif();
setInterval(() => {
  loadCart();
  loadNotif();
}, 30000);
</script>

</body>
</html>

