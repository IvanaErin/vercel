<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<title>Staff Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root {
  --accent:#6f3fb3;
  --lilac:#b99ff1;
  --muted:#f7f5fb;
}
body { background:var(--muted); }

.sidebar {
  width:220px;
  height:100vh;
  position:fixed;
  background:#fff;
  padding-top:1rem;
  box-shadow:2px 0 5px rgba(0,0,0,.1);
}
.sidebar a {
  display:block;
  padding:.75rem 1rem;
  color:#444;
  text-decoration:none;
  font-weight:500;
}
.sidebar a.active, .sidebar a:hover {
  background:var(--lilac);
  color:#fff;
}
.badge {
  background:var(--accent);
  font-size:12px;
}
.main {
  margin-left:220px;
  padding:2rem;
}
.card { border-radius:12px; }
</style>

</head>

<body>

<!-- SIDEBAR -->

<div class="sidebar">
  <h4 class="px-3" style="color:var(--accent)">Staff Portal</h4>
  <a class="active">Dashboard</a>
  <a href="/menu_management.html">Menu Management</a>
  <a href="/orders.html">
    Orders <span class="badge d-none" id="pendingBadge"></span>
  </a>
  <a href="/notifications.html">
    Notifications <span class="badge d-none" id="notifBadge"></span>
  </a>
  <a href="/sales.html">Sales Overview</a>
  <a href="#" onclick="logout(event)">Logout</a>
</div>

<!-- MAIN -->

<div class="main">
  <div class="text-end mb-3">
    Welcome, <b id="staffName">Staff</b>
  </div>

  <!-- STATS -->

  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card p-3">
        <div>Total Sales</div>
        <h2 id="totalSales">₱0.00</h2>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <div>Pending Orders</div>
        <h2 id="pendingOrders">0</h2>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <div>Completed Today</div>
        <h2 id="completedToday">0</h2>
      </div>
    </div>
  </div>

  <!-- RECENT ORDERS -->

  <div class="card">
    <div class="card-header"><b>Recent Orders</b></div>
    <div class="card-body">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>#</th>
            <th>Customer</th>
            <th>Total</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="ordersTable">
          <tr><td colspan="5">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ---------------- AUTH GUARD ---------------- */
const token = localStorage.getItem("staff_token");
if (!token) {
  location.href = "/staff_login.html";
}

/* ---------------- LOGOUT ---------------- */
function logout(e){
  e.preventDefault();
  localStorage.removeItem("staff_token");
  localStorage.removeItem("staff_role");
  location.href = "/staff_login.html";
}

/* ---------------- FETCH DASHBOARD ---------------- */
fetch("/api/staff-dashboard", {
  headers:{ Authorization:"Bearer " + token }
})
.then(res => {
  if (!res.ok) throw new Error("Unauthorized");
  return res.json();
})
.then(d => {
  // Staff
  document.getElementById("staffName").textContent = d.staff.username;

  // Stats
  document.getElementById("totalSales").textContent =
    "₱" + Number(d.stats.total_sales || 0).toFixed(2);

  document.getElementById("pendingOrders").textContent =
    d.stats.pending || 0;

  document.getElementById("completedToday").textContent =
    d.stats.completed_today || 0;

  // Badges
  if (d.stats.pending > 0) {
    pendingBadge.textContent = d.stats.pending;
    pendingBadge.classList.remove("d-none");
  }

  if (d.stats.notifications > 0) {
    notifBadge.textContent = d.stats.notifications;
    notifBadge.classList.remove("d-none");
  }

  // Orders
  ordersTable.innerHTML = d.orders.length
    ? d.orders.map(o => `
      <tr>
        <td>${o.id}</td>
        <td>${o.customer}</td>
        <td>₱${Number(o.total).toFixed(2)}</td>
        <td>${o.status}</td>
        <td>
          <a class="btn btn-sm btn-secondary"
             href="/receipt.html?order_id=${o.id}"
             target="_blank">
             Receipt
          </a>
        </td>
      </tr>
    `).join("")
    : `<tr><td colspan="5">No orders found</td></tr>`;
})
.catch(err => {
  console.error(err);
  localStorage.removeItem("staff_token");
  location.href = "/staff_login.html";
});
</script>

</body>
</html>
